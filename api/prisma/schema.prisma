generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum LinkStatus {
  ACTIVE
  REVOKED
}

enum RecordedByType {
  PATIENT
  CAREGIVER
}

model Medication {
  id                  String   @id @default(uuid())
  patientId           String
  name                String
  dosageText          String
  doseCountPerIntake  Int
  dosageStrengthValue Float
  dosageStrengthUnit  String
  notes               String?
  startDate           DateTime @db.Date
  endDate             DateTime? @db.Date
  inventoryCount      Int?
  inventoryUnit       String?
  isActive            Boolean  @default(true)
  isArchived          Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  regimens    Regimen[]
  doseRecords DoseRecord[]

  @@index([patientId, isActive])
  @@index([patientId, startDate, endDate])
}

model Regimen {
  id           String      @id @default(uuid())
  patientId    String
  medicationId String
  timezone     String
  startDate    DateTime @db.Date
  endDate      DateTime? @db.Date
  times        String[]
  daysOfWeek   DayOfWeek[]
  enabled      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  medication Medication @relation(fields: [medicationId], references: [id])

  @@index([patientId, medicationId, enabled])
  @@index([patientId, startDate, endDate])
}

model Patient {
  id          String   @id @default(uuid())
  caregiverId String
  displayName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  links           CaregiverPatientLink[]
  linkingCodes    LinkingCode[]
  linkingAttempts LinkingAttempt[]
  sessions        PatientSession[]
  doseRecords     DoseRecord[]
}

model CaregiverPatientLink {
  id          String     @id @default(uuid())
  caregiverId String
  patientId   String     @unique
  status      LinkStatus @default(ACTIVE)
  revokedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([caregiverId])
}

model LinkingCode {
  id        String   @id @default(uuid())
  patientId String
  codeHash  String
  expiresAt DateTime
  usedAt    DateTime?
  issuedBy  String
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([codeHash])
  @@index([patientId, expiresAt])
}

model PatientSession {
  id            String   @id @default(uuid())
  patientId     String
  tokenHash     String   @unique
  issuedAt      DateTime @default(now())
  expiresAt     DateTime?
  lastRotatedAt DateTime?
  revokedAt     DateTime?

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([revokedAt])
}

model DoseRecord {
  id             String         @id @default(uuid())
  patientId      String
  medicationId   String
  scheduledAt    DateTime
  takenAt        DateTime       @default(now())
  recordedByType RecordedByType
  recordedById   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  patient    Patient    @relation(fields: [patientId], references: [id])
  medication Medication @relation(fields: [medicationId], references: [id])

  @@unique([patientId, medicationId, scheduledAt])
  @@index([patientId, scheduledAt])
}

model LinkingAttempt {
  id           String   @id @default(uuid())
  patientId    String   @unique
  attemptCount Int      @default(0)
  lockedUntil  DateTime?
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([lockedUntil])
}
