generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum LinkStatus {
  ACTIVE
  REVOKED
}

enum RecordedByType {
  PATIENT
  CAREGIVER
}

enum InventoryAlertState {
  NONE
  LOW
  OUT
}

enum InventoryAlertType {
  LOW
  OUT
}

enum InventoryAdjustmentReason {
  REFILL
  SET
  CORRECTION
  TAKEN_CREATE
  TAKEN_DELETE
}

enum InventoryAdjustmentActorType {
  CAREGIVER
  SYSTEM
}

enum EntitlementStatus {
  ACTIVE
  REVOKED
}

model Medication {
  id                  String   @id @default(uuid())
  patientId           String
  name                String
  dosageText          String
  doseCountPerIntake  Float
  dosageStrengthValue Float
  dosageStrengthUnit  String
  notes               String?
  isPrn               Boolean @default(false)
  prnInstructions     String?
  startDate           DateTime @db.Date
  endDate             DateTime? @db.Date
  inventoryCount      Float?
  inventoryUnit       String?
  inventoryEnabled    Boolean @default(false)
  inventoryQuantity   Float   @default(0)
  inventoryLowThreshold Int   @default(0)
  inventoryUpdatedAt  DateTime?
  inventoryLastAlertState InventoryAlertState?
  isActive            Boolean  @default(true)
  isArchived          Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  regimens            Regimen[]
  doseRecords         DoseRecord[]
  prnDoseRecords      PrnDoseRecord[]
  inventoryAdjustments MedicationInventoryAdjustment[]
  inventoryAlertEvents InventoryAlertEvent[]

  @@index([patientId, isActive])
  @@index([patientId, startDate, endDate])
}

model Regimen {
  id           String      @id @default(uuid())
  patientId    String
  medicationId String
  timezone     String
  startDate    DateTime @db.Date
  endDate      DateTime? @db.Date
  times        String[]
  daysOfWeek   DayOfWeek[]
  enabled      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  medication Medication @relation(fields: [medicationId], references: [id])

  @@index([patientId, medicationId, enabled])
  @@index([patientId, startDate, endDate])
}

model Patient {
  id          String   @id @default(uuid())
  caregiverId String
  displayName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  links                 CaregiverPatientLink[]
  linkingCodes          LinkingCode[]
  linkingAttempts       LinkingAttempt[]
  sessions              PatientSession[]
  doseRecords           DoseRecord[]
  prnDoseRecords        PrnDoseRecord[]
  doseRecordEvents      DoseRecordEvent[]
  inventoryAdjustments  MedicationInventoryAdjustment[]
  inventoryAlertEvents  InventoryAlertEvent[]
}

model CaregiverPatientLink {
  id          String     @id @default(uuid())
  caregiverId String
  patientId   String     @unique
  status      LinkStatus @default(ACTIVE)
  revokedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([caregiverId])
}

model LinkingCode {
  id        String   @id @default(uuid())
  patientId String
  codeHash  String
  expiresAt DateTime
  usedAt    DateTime?
  issuedBy  String
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([codeHash])
  @@index([patientId, expiresAt])
}

model PatientSession {
  id            String   @id @default(uuid())
  patientId     String
  tokenHash     String   @unique
  issuedAt      DateTime @default(now())
  expiresAt     DateTime?
  lastRotatedAt DateTime?
  revokedAt     DateTime?

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([revokedAt])
}

model DoseRecord {
  id             String         @id @default(uuid())
  patientId      String
  medicationId   String
  scheduledAt    DateTime
  takenAt        DateTime       @default(now())
  recordedByType    RecordedByType
  recordedById      String?
  recordingGroupId  String?
  createdAt         DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  patient    Patient    @relation(fields: [patientId], references: [id])
  medication Medication @relation(fields: [medicationId], references: [id])

  @@unique([patientId, medicationId, scheduledAt])
  @@index([patientId, scheduledAt])
}

model PrnDoseRecord {
  id            String         @id @default(uuid())
  patientId     String
  medicationId  String
  takenAt       DateTime       @default(now())
  quantityTaken Float
  actorType     RecordedByType
  createdAt     DateTime       @default(now())

  patient       Patient        @relation(fields: [patientId], references: [id])
  medication    Medication     @relation(fields: [medicationId], references: [id])

  @@index([patientId, takenAt(sort: Desc)])
  @@index([patientId, medicationId, takenAt(sort: Desc)])
  @@map("prn_dose_records")
}

model DoseRecordEvent {
  id         String   @id @default(uuid())
  patientId  String
  scheduledAt DateTime
  takenAt    DateTime
  withinTime Boolean
  displayName String
  medicationName String?
  isPrn      Boolean @default(false)
  createdAt  DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId, createdAt])
}

model MedicationInventoryAdjustment {
  id          String                    @id @default(uuid())
  patientId   String
  medicationId String
  delta       Float
  reason      InventoryAdjustmentReason
  actorType   InventoryAdjustmentActorType
  actorId     String?
  createdAt   DateTime                  @default(now())

  patient     Patient                   @relation(fields: [patientId], references: [id])
  medication  Medication                @relation(fields: [medicationId], references: [id])

  @@index([patientId, createdAt])
  @@index([medicationId, createdAt])
}

model InventoryAlertEvent {
  id           String             @id @default(uuid())
  patientId    String
  medicationId String
  type         InventoryAlertType
  remaining    Float
  threshold    Int
  patientDisplayName String?
  medicationName     String?
  createdAt    DateTime           @default(now())

  patient      Patient            @relation(fields: [patientId], references: [id])
  medication   Medication         @relation(fields: [medicationId], references: [id])

  @@index([patientId, createdAt])
  @@index([medicationId, createdAt])
}

model LinkingAttempt {
  id           String   @id @default(uuid())
  patientId    String   @unique
  attemptCount Int      @default(0)
  lockedUntil  DateTime?
  updatedAt    DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@index([lockedUntil])
}

model DeviceToken {
  id           String   @id @default(uuid())
  caregiverId  String
  token        String
  platform     String   @default("ios")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([caregiverId, token])
  @@index([caregiverId])
}

model CaregiverEntitlement {
  id                    String            @id @default(uuid())
  caregiverId           String
  productId             String
  status                EntitlementStatus @default(ACTIVE)
  originalTransactionId String            @unique
  transactionId         String
  purchasedAt           DateTime
  environment           String            @default("Production")
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([caregiverId])
}
