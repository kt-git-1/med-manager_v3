openapi: 3.0.3
info:
  title: Billing Foundation API (008)
  version: 0.1.0
  description: |
    Endpoints for In-App Purchase claim and entitlement management.
    Caregiver authentication (Bearer token) is required for all endpoints.
servers:
  - url: /api
paths:
  /iap/claim:
    post:
      summary: Claim IAP entitlement (caregiver)
      description: |
        Submit a signed transaction from StoreKit2 to register or update
        a premium entitlement for the authenticated caregiver account.
        Upserts by originalTransactionId to prevent duplicate registrations.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClaimRequest"
      responses:
        "200":
          description: Entitlement claimed or updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClaimResponse"
        "401":
          description: Unauthorized — missing or invalid caregiver token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error — missing or invalid fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
  /me/entitlements:
    get:
      summary: Get caregiver entitlements
      description: |
        Returns the server-recognized premium status and entitlement records
        for the authenticated caregiver account.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Entitlement status and records
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EntitlementsResponse"
        "401":
          description: Unauthorized — missing or invalid caregiver token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Caregiver Bearer token (Supabase JWT with caregiver- prefix)
  schemas:
    ClaimRequest:
      type: object
      required:
        - productId
        - signedTransactionInfo
      properties:
        productId:
          type: string
          description: App Store product identifier
          example: com.yourcompany.medicationapp.premium_unlock
        signedTransactionInfo:
          type: string
          description: JWS-encoded signed transaction from StoreKit2
        environment:
          type: string
          enum:
            - Sandbox
            - Production
          description: Optional; defaults to Production if omitted
    ClaimResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - premium
            - productId
            - status
            - updatedAt
          properties:
            premium:
              type: boolean
              description: Whether the caregiver now has active premium access
            productId:
              type: string
            status:
              type: string
              enum:
                - ACTIVE
                - REVOKED
            updatedAt:
              type: string
              format: date-time
    EntitlementsResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - premium
            - entitlements
          properties:
            premium:
              type: boolean
              description: True if at least one ACTIVE entitlement exists
            entitlements:
              type: array
              items:
                $ref: "#/components/schemas/EntitlementRecord"
    EntitlementRecord:
      type: object
      required:
        - productId
        - status
        - purchasedAt
        - originalTransactionId
      properties:
        productId:
          type: string
        status:
          type: string
          enum:
            - ACTIVE
            - REVOKED
        purchasedAt:
          type: string
          format: date-time
        originalTransactionId:
          type: string
    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code (e.g., unauthorized, not_found)
        message:
          type: string
          description: Human-readable error description
    ValidationErrorResponse:
      type: object
      required:
        - error
        - messages
      properties:
        error:
          type: string
          example: validation
        messages:
          type: array
          items:
            type: string
          description: List of validation error messages
