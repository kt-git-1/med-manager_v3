# 000 Domain Policy (MVP 共通仕様)

## 目的
本ドキュメントは、MVP機能（001以降の各spec）に共通する「絶対ルール」「用語」「権限モデル」「データ・時間の扱い」「API/UXの共通要件」「品質基準」を定義する。
各feature specは、本ドキュメントを前提として記述し、矛盾がある場合は本ドキュメントを更新して整合させる。

---

## スコープ
- 対象：アプリ全体の共通仕様（権限、データ境界、エラー、ログ、テスト標準、UX原則など）
- 非対象：各機能の詳細な画面設計・詳細API設計（001以降で定義）

---

## 用語（Glossary）
- **Caregiver（家族）**：患者の服薬管理を主に行うユーザー。基本的に作成/編集の主体。
- **Patient（患者）**：閲覧中心のユーザー。基本は受動的な利用を想定。
- **Patient Link（連携）**：患者が連携コードを入力して、特定の患者データにアクセスできる状態になること。
- **Medication（薬）**：服用対象の薬。
- **Regimen（スケジュール定義）**：薬の服用パターン（曜日/時刻/開始終了など）。
- **Scheduled Dose（予定）**：Regimenから生成される「特定日時に服用する予定」。（DBに保存せず生成する方針が基本）

---

## アプリ形態（重要）
- iOSは「1アプリ」に統一し、**家族モード / 患者モード**の2モードを提供する。
- 家族はログインして患者データを管理できる。
- 患者は「連携コード」により患者データにアクセスする（ログイン負担を避ける）。

---

## 認証・認可（AuthZ/AuthN）共通原則
### ロール
- caregiver: 書き込み主体（薬/スケジュールなどの作成・編集・アーカイブ）
- patient: 閲覧主体（原則 read-only、詳細は各specで明記）

### 取得できるデータ範囲
- すべてのデータは **patientId** を所有境界として分離される。
- APIは「呼び出し主体（caregiver/patient）」と「アクセス可能なpatientIdスコープ」を確定してから処理する。
- **deny-by-default**：アクセスが明示的に許可されない場合は拒否する。

### エラーの使い分け方針
- 401: 認証情報がない/無効
- 403: 認証済みだが権限がない（例：患者が更新APIを叩く）
- 404: 対象が存在しない、または「他patientIdのリソース」である（情報漏洩を避ける）
- 422: 入力不正（バリデーション）
- 409: 整合性衝突（重複、二重登録など）

---

## データ・時間・タイムゾーンの共通方針
### 日付と時刻
- UI入力では「日付（YYYY-MM-DD）」と「時刻（HH:mm）」を基本単位として扱う。
- scheduledAt の生成・表現は timezone を考慮し、**秒は0固定**など正規化ルールを持つ。
- timezone は原則「ユーザーのローカル timezone」を使用し、データモデルに保存（例：Asia/Tokyo）。

### 期間の境界
- from/to の範囲指定がある場合、「含む/含まない」ルールをspecに明記する（推奨：日付は両端含む）。

---

## Scheduled Dose（予定）に関する共通方針
- 予定（Scheduled Dose）は、原則 **DBに事前保存しない**。
- 期間クエリによりRegimenから生成し、予定の安定キーは以下：
  - **(patientId, medicationId, scheduledAt)**
- 後続の服用記録（adherence event）等は、scheduledAtに紐づけて保存し、表示時は「生成予定 + 保存済み記録」をマージする。

---

## データの変更・削除方針
- 原則：物理削除より **ソフト削除（アーカイブ）** を優先する（監査・復旧・参照整合のため）。
- 参照整合や履歴の要件がある場合、削除ではなく isActive / archivedAt で扱う。
- 重要データの一括更新・破壊的変更は避ける（必要なら移行計画をspecに記述）。

---

## セキュリティ / プライバシー共通原則
- 個人/健康関連データは機微情報として扱う。
- ログにトークン・PII・機微情報を出さない（必要ならマスク）。
- 入力検証を徹底し、一般的な脆弱性（例：:contentReference[oaicite:0]{index=0} が示すリスク）を回避する。
- Secretsはリポジトリにコミットしない。漏洩前提でローテーション可能な運用とする。

---

## UX共通原則（iOS）
- エラー状態は必ず「ユーザーが次に取れる行動」を提示する（再試行、入力修正、設定誘導など）。
- Loading / Empty / Error を必ず設計する（真っ白画面を避ける）。
- 二重送信防止（ボタンdisable、リクエスト中表示等）を基本とする。
- アクセシビリティ：Dynamic Type、VoiceOverラベル、十分なコントラストを考慮。
- i18n：文字列直書きを避け、将来の多言語化に備える（最低限：日本語を破綻させない）。

---

## API共通原則（契約・互換性）
- APIは契約（request/response）をspecに明記し、破壊的変更を避ける。
- 破壊的変更が必要な場合は、移行計画・互換性・非推奨期間を定義する。
- エラーは機械判定可能な形式（code等）とユーザー向けメッセージの方針を持つ。

---

## パフォーマンス・信頼性（ガードレール）
- 「測ってから最適化」を原則とする。
- N+1クエリや過剰なデータ取得を避ける。
- 典型利用（例：7〜31日範囲の予定取得）で実用性能を満たすこと。
- 回帰（遅くなる/エラー増える）が発生しうる変更は、前後比較や根拠を残す。

---

## テスト標準（共通）
- テストは決定的で独立していること（順序依存を避ける）。
- 外部サービスへの実通信に依存しない（必要ならfixture/mock）。
- バグ修正には回帰テストを追加する。
- 高リスク領域（認証/認可、データ整合、機微情報）には厚めのテストを要求する。

---

## ドキュメント整備（共通）
- specが挙動の真実（Single Source of Truth）。
- 重要な設計判断は簡潔に残す（Decision/Rationale など）。
- 変更に伴うドキュメント更新は同じPRで行う。

---

## プロジェクト前提（実装スタック：参考）
※この節は「前提の共有」が目的で、各featureの挙動仕様を縛るものではない。
- 認証基盤：:contentReference[oaicite:1]{index=1}
- DB：:contentReference[oaicite:2]{index=2}
- ORM：:contentReference[oaicite:3]{index=3}
- Backend/API：:contentReference[oaicite:4]{index=4}
- Deploy：:contentReference[oaicite:5]{index=5}（無料枠想定）
- iOS UI：:contentReference[oaicite:6]{index=6}

---

## このspecの更新ルール
- 000は共通仕様のため、変更は慎重に行う。
- 000を更新した場合、影響する既存feature spec（001以降）に矛盾がないか確認し、必要に応じて追随修正する。
