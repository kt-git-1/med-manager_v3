# Feature Specification: Family Linking (SDD)

**Feature Branch**: `002-family-linking`  
**Created**: 2026-02-01  
**Status**: Draft  
**Input**: User description: "SDDの spec を作成してください。家族/患者モード、連携コード、patientSessionToken、解除の仕様を定義する"

## Clarifications

### Session 2026-02-01

- Q: patientSessionToken の有効期限モデルはどれか → A: 解除されるまで有効（refreshで延長、実質スライディング）
- Q: 連携コードの試行回数上限はどれか → A: 5回まで
- Q: 連携コードの再発行ポリシーはどれか → A: 再発行時に既存コードを即時無効化する
- Q: 連携コードの入力ロックアウト時間はどれか → A: 5分ロック
- Q: 患者の閲覧APIの対象範囲（002時点）はどれか → A: 薬一覧 + 今日の予定

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 家族が患者を作成し連携コードを発行 (Priority: P1)

家族は患者の表示名を入力して患者を作成し、患者向けの連携コードを発行できる。患者はログイン不要で家族が管理を開始できる。

**Why this priority**: 患者データ管理の起点となるため最優先。

**Independent Test**: 家族が患者を作成し、一覧に表示され、連携コードが発行できることを確認する。

**Acceptance Scenarios**:

1. **Given** 家族がログイン済み（Supabase Auth）、**When** 患者の表示名を入力して作成する、**Then** 患者が一覧に表示される
2. **Given** 患者が存在する、**When** 連携コードを発行する、**Then** 有効期限付きのワンタイムコードが表示される

---

### User Story 2 - 患者が連携コードでセッションを取得して閲覧 (Priority: P2)

患者は連携コードを入力してpatientSessionTokenを取得し、患者スコープの閲覧APIにアクセスできる。

**Why this priority**: 患者が自分のスケジュールを閲覧できる価値がMVP成立条件。

**Independent Test**: 連携コードを入力しトークン取得後、閲覧APIが成功することを確認する。

**Acceptance Scenarios**:

1. **Given** 期限内で未使用の連携コード、**When** 患者がコードを入力する、**Then** patientSessionTokenが発行される
2. **Given** patientSessionTokenがある、**When** 閲覧APIにアクセスする、**Then** 患者スコープのデータが取得できる

---

### User Story 3 - 家族がリンク解除して患者セッションを失効 (Priority: P3)

家族はリンクを解除し、患者のセッションを失効できる。患者データ自体は削除しない。

**Why this priority**: 誤リンクや運用終了時の安全性確保に必要。

**Independent Test**: 解除後に既存トークンの閲覧・更新が失敗することを確認する。

**Acceptance Scenarios**:

1. **Given** 患者がリンク済み、**When** 家族が解除する、**Then** リンクが解除され患者セッションが失効する
2. **Given** 解除済みの患者セッション、**When** 閲覧またはリフレッシュを試みる、**Then** 失敗が返る

---

### Edge Cases

- 連携コードが期限切れ・再利用・未登録のときは交換できない
- 表示名が空白のみの場合は作成できない
- 同一患者が別家族にリンク済みの場合は新規リンクを拒否する
- 解除済みセッションのrefreshが繰り返し試行される
- 連携コードの試行回数が上限を超える
- 家族モードで未ログインの場合はログイン/サインアップ画面へ誘導される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 家族は患者を作成でき、`displayName`は必須かつ空白のみは不可で、最大50文字とする
- **FR-002**: 家族は患者一覧を取得できる
- **FR-003**: 家族は患者に対して短寿命・ワンタイムの連携コードを発行できる
- **FR-004**: 患者は連携コードを交換してpatientSessionTokenを取得できる
- **FR-005**: 患者はpatientSessionTokenで閲覧APIにアクセスできる
- **FR-005a**: 002時点の患者閲覧APIは「薬一覧」と「今日の予定」を提供する
- **FR-006**: patientSessionTokenは解除されるまで有効で、refreshにより有効期限が延長される
- **FR-007**: 家族はリンク解除でき、リンク解除時に患者セッションは失効する
- **FR-008**: リンク解除は患者データを削除しない
- **FR-009**: 1患者=1家族の制約に違反するリンクは拒否される
- **FR-010**: 連携コードは有効期限内のみ有効で、再利用できない
- **FR-011**: 連携コードの試行回数制限（最大5回）とレート制限が適用される
- **FR-011a**: 連携コード再発行時は既存コードを即時無効化する
- **FR-011b**: 試行回数上限に達した場合は5分間ロックアウトする
- **FR-012**: エラーは000-domain-policyに従い、以下を満たす  
  - 401: 認証未完了（必要なトークンなし/無効）  
  - 403: 役割不一致（家族専用/患者専用の操作）  
  - 404: 対象リソースが存在しない（患者/リンク/コード）  
  - 409: 1患者=1家族制約違反、または既存リンクがある  
  - 422: 入力不正（空白の表示名、コード形式不正）  
  - 429: 試行回数超過またはレート制限
- **FR-012a**: 家族モードの認証はSupabase Auth（メール/パスワード）で行う
- **FR-012b**: 家族モードはログインに加えてサインアップを提供する
- **FR-013**: アプリ起動時に「患者 / 家族」モード選択ができる
- **FR-014**: 家族モードはログイン/サインアップ完了後に薬タブと連携/患者タブを提供する
- **FR-015**: 患者モードは「今日」「履歴」タブを提供し、履歴は準備中表示ができる

### Non-Functional Requirements *(mandatory)*

- **NFR-001 (Performance)**: 連携コード交換は95%のケースで2秒以内に完了する
- **NFR-002 (Security/Privacy)**: 連携コードは平文保存せず、短寿命・ワンタイム・試行回数制限を満たす
- **NFR-003 (UX/Accessibility)**: 入力エラーや期限切れはユーザーに分かる文言で提示される
- **NFR-004 (Documentation/Operations)**: 連携フロー、エラー方針、解除手順が仕様に記載される

### Key Entities *(include if feature involves data)*

- **Patient**: 患者プロフィール。`displayName`を持ち、家族が管理する対象
- **CaregiverPatientLink**: 家族と患者のリンク。1患者=1家族の制約を表す
- **LinkingCode**: 患者向けワンタイムコード。期限、使用済み状態、試行回数制限と関連
- **PatientSession**: 患者の閲覧セッション。解除で失効し、refreshの対象

### Assumptions

- 連携コードの有効期限は発行から15分以内とする
- 連携コードの入力試行上限は5回とする
- 試行回数上限到達時のロックアウトは5分とする
- patientSessionTokenは解除まで有効で、refreshにより期限が延長される
- displayName の最大長は50文字とする
- 家族モードの認証はSupabase Auth（メール/パスワード）を使用する

### Out of Scope

- 患者アカウント登録（メール/パスワード等）
- 服用記録（003で実装）
- 履歴カレンダー（004で実装）
- 複数家族による同一患者の共有

### Dependencies

- 既存の家族ログイン機能
- 001で提供される薬一覧などの閲覧データ
- 000-domain-policyのエラー方針

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 家族の患者作成が1分以内に完了する割合が90%以上
- **SC-002**: 連携コード交換が95%のケースで2秒以内に完了する
- **SC-003**: 解除後の既存トークンでの閲覧・更新が100%失敗する
- **SC-004**: 連携コードの再利用成功率が0%である
